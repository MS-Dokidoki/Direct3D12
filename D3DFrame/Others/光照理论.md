# Direct3D 光照理论

## 光照模型概述
光照模型一般分为两种类型: **局部光照模型**与**全局光照模型**。

在局部光照模型下，所有物体的光照都是独立于其它物体的，因此我们可以直接考虑从光源直接发出的光线；
在全局光照模型下，我们不仅仅需要考虑来自光源的光线，还需要考虑其它物体反射光线。

不过全局光照的计算量是一般实时应用无法承担得起的。

### 冯氏光照模型(Phong Lighting Model)和 Blinn-Phong 光照模型
冯氏光照模型是 1975年 phong 提出的第一个有影响的简单光照模型。
它的组成部分主要为三个: **环境光照(Ambient)**、**漫反射光照(Diffuse)**和**镜面光照(Specular)**.

在大部分情况下，该模型都能很好的模拟出较为真实的画面，并且具有较高的性能，不过这个模型有一点点小缺陷。
因此，James F. Blinn 在 1977 年对冯氏光照模型进行了拓展，提出了Blinn-Phong 光照模型。
它与冯氏光照模型十分相似，但在镜面光照上的处理有所不同。

### 基于物理的渲染模型(Physically Based Rendering/PBR)


---
## 漫反射光照(Diffuse Reflection Light)
当光线照射到物体表面的某一个点时，一部分光会进入物体内部，并于内部的物质进行相互作用，
这些光会在物体内部四处反弹，其中一部分会被物体吸收，而余下部分则会向各个方向散射到物体表面，这就是所谓的漫反射。

漫反射光照的计算可以分为两部分。
在第一部分中，我们需要指定光照颜色以及**漫反射反照率(diffuse albedo)颜色**。漫反射反照率颜色表示的是根据表面的漫反射率而被反射的入射光量。

假设入射光为 $B_L = (0.8, 0.8, 0.8)$, 一个物体表面上一点的的漫反射反照率为$m_d = (0.5, 1.0, 0.75)$, 则该点的反射光量为:
$$
	c_d = B_L \otimes m_d = (0.8, 0.8, 0.8) \otimes (0.5, 1.0, 0.75) = (0.4, 0.8, 0.6)
$$
可以发现，漫反射反照率的分量必定在 0.0 ~ 1.0 之间。
然而，上述方法并非十分准确，当光线以一定角度入射到物体表面时，还需要考虑其辐射通量，由此我们需要引入朗博余弦定理:
$$
	c_d = max(L \cdot n, 0) \cdot B_L \otimes m_d
$$

### 朗博余弦定理(Lambert's Cosine Law)
我们可以将光看作是光子的集合，在空间中以特定的方向传播。每个光子都载有(光)能量。

光源每秒发出的(光)能量被称为**辐射通量(radiant flux)**; 而单位面积上的辐射通量密度(irradiance 辐照度/辐射)，
是一个很重要的概念，一般来讲，它可以被认为是光线照射到表面某区域的光量，或者是通过空间中某个假想区域的光量，
由此，我们可以利用它确定观测者所感受到的明亮度。

![图1.0](./MarkdownImages/1.0.png#pic_center)

当一束辐射通量为 P 的光线打到横截面积为 A1 的表面上时，则 A1 的辐照度为 $E_1 = P / A_1$。
若旋转光源，使光线以某个入射角打在表面上时，则光束将覆盖在更大面积的 A2 上，
此时，该面积的辐照度为$E_2 = P / A_2$。
由三角学可得, A1 和 A2 的关系为:
$$\begin{aligned}
	cos\theta= {A_1 \over A_2} 				\\
	{1 \over A_2} = {cos\theta \over A_1}
\end{aligned}$$
所以,
$$
	E_2 = {p \over A_2} = {p \over A_1}cos\theta = E_1cos\theta = E_1(\vec{n} \cdot \vec{L})
$$
(注: $\vec{n}$ 为平面法线，$\vec{L}$ 为入射光线的向量)

总而言之，面积 A2 内的辐照度就相当于将受垂直方向的面积 A1 内的辐照度按比例$\vec{n} \cdot \vec{L} = cos\theta$ 进行缩放。
这便是**朗博余弦定律**。

考虑到 $cos\theta$ 可能为负值，我们可以采用 max 函数对"缩放因子"进行钳制(clamp):
$$
	f(\theta) = max(cos\theta, 0) = max(\vec{n}\cdot\vec{L}, 0)
$$


---
## 环境光照(Ambient Light)
由于我们使用的是局部光照模型，所以并不会考虑来自其它物体的反射光线。
但事实上，我们在真实世界中看到的更多是间接光。
为了处理这种间接光，我们给光照方程中引入了环境光:
$$
	c_a = A_1 \otimes m_d
$$
其中, A1 指定了表面接收到的环境光量; 漫反射反照率$m_d$指定了根据表面反射率而被反射的入射光量，同时，
我们也借用此值来表明被表面反射的入射环境光量。


---
## 镜面光照(Specular Light)
当光线到达两种不同折射率(index of refraction)介质之间的界面时，一部分光将被反射，而剩下的光将发生折射(refract)。

这种现象便是我们模拟漫反射过程的第二部分: 根据名为菲涅尔效应(Fresnel effect)的物理现象的反射。
我们将第二种光的反射过程称为镜面反射(specular reflection), 而被反射的光称为镜面(反射)光(specular light)。

* 折射率和折射光

折射率, 是一种介质的物理性质，即光线在真空中的传播速度与光在给定介质内的传播速度之比。

如果折射光从介质的另一侧射出并进入观察者的眼中，那么这个物体看起来就是透明的。
对于不透明的物体而言，折射光进入介质并根据漫反射率发生漫反射(在物质内部四处反弹后从表面射出)。

由此可以得知，从表面发生反射和进入眼睛的光实际上是由物体的漫反射光和镜面反射光构成的。
与漫反射光相比，镜面反射光可能并不会进入观察者的眼中，因为其反射只会发生在某一特定角度。
所以，镜面反射光的计算是与观察点有关的。


### 菲涅尔效应(Fresnel Effect)
假设在一个具有法线$\vec{n}$的平滑表面(即粗糙度为 0)，它将两种不同折射率的介质分割开来。
由于在界面处具有折射率的不连续性(是不同介质的折射率差异导致的)，当光线照射到界面时，一部分光将被反射，而剩下的光将发生折射。

菲涅尔方程(Fresnel equations)以数学的方式，描述了入射光被反射的百分比。

即 $0 <= R_F <= 1$。根据能量守恒定律，如果$R_F$是反射光量，则$1-R_F$为折射光量。

反射光量即依赖于介质，也依赖于法向量$n$和光向量$L$之间的夹角$\theta_i$。

由于光照过程的复杂性，这里采用石里克近似法(Schlick approximation)进行代替:
$$
	R_F(\theta_i) = R_F(0°) + (1-R_F(0°))(1 - cos\theta_i)^5
$$
(注: $R_F$反射光量是一个 RGB 向量)

$R_F(0°)$是介质的一种属性，下表列举一些常见材质的对应属性数值:

![图 2.0](./MarkdownImages/2.0.jpeg#img_center)


* 一个例子

思考下图,

![图 2.1](./MarkdownImages/2.1.jpeg#img_center)

假设我们正处于一个水质相对清澈，深度较深的小池塘。若向下俯视，我们可以基本看清楚水底下沉积的沙石。
这是由于从周围环境中照射到池水的光以接近 0.0° 的小角度$\theta_i$反射进入我们眼睛;
如此一来，反射到我们眼中的光量相对较低，根据能量守恒定律可知，折射光量很高$[1 - R_F(\theta_i)]$。
$$
	R_F(\theta_i) = (0.02, 0.02, 0.02) + [1 - (0.02, 0.02, 0.02)](1 - cos\theta_i)				
$$
(注: $\theta_i$接近 0.0 °, 因此 $cos\theta_i$ 将接近 1, $R_F(\theta_i)$则趋近于$R_F(0°)$)

换个角度，如果我们向稍远处望去，将会看到池水极强的反射光。
这是由于有从周围环境中射向水的光以接近 90.0° 的角度$\theta_i$反射进入我们的眼中，从而增加了反射光量(公式解析同上)。

这种现象便是菲涅尔效应的一个实例。通过该实例，我们可以简洁的将其概括为: 反射光量($R_F(\theta_i)$)取决于材质($R_F(0°)$)以及法线与光向量之间的夹角。

### 表面粗糙度(Roughness)

在真实世界中，并不存在理想镜面(粗糙度为 0), 任何物体在微观层面上都具有一定的粗糙度。
当表面粗糙度为 0 时, 微表面与宏表面上的法线方向是一致的; 随着粗糙度的增大，微表面法线开始逐渐偏离宏表面法线，
使该宏表面的反射光逐渐扩展为一个**镜面瓣**。

我们采用**微平面(microfacet)模型**，对粗糙度进行建模。
我们将微观表面模拟为由多个微小又平滑的微平面所构成的集合。
针对由该片段指向观察者的单位向量$\vec{v}$以及由该片段指向光源的单位向量$\vec{L}$，我们需要了解由$\vec{L}$向$\vec{v}$反射的所有微平面片段的分布情况。
即, 法线为$\vec{h} = normalize(\vec{L} + \vec{v})$这种微平面片段在所有微平面中的占比(此微平面片段在该微表面的面积大小)。
通过该方法，来确定有多少光通过镜面反射的方式，从此路径进入观察者的眼中。
若有更多的光向量$\vec{L}$能与观察向量$\vec{v}$发生镜面反射，则观察者在该角度所看到的镜面光就更明亮。

此外，我们还需要引入一个中间向量$\vec{h}$和宏表面法线$\vec{n}$之间的夹角$\theta_h$。
同时定义一个函数$\rho(\theta_h) \in [0, 1]$, 用于表示为$\theta_h$的微平面分布情况。
对于该函数，我们直观上希望，但$\theta_h$为 0° 时，该函数取最大值，使微平面法线平行于宏表面法线；
同时我们也希望，随着$\theta_h$的增大(微平面法线逐渐偏离宏表面法线)，这些以该微平面法线的微平面片段数量减少(面积变小)。
$$
	\rho(\theta_h) = cos^m(\theta_h) = (\vec{n} \cdot \vec{h})^m
$$

其中, m 控制的是粗糙度，它指定了所有以微表面法线$\vec{h}$与宏表面法线$\vec{n}$之间夹角为$\theta_h$的微平面片段。
随着了 m 的减小，表面变得更加粗糙，而微表面法线也更加偏离宏表面法线；随着 m 的增大，表面变得更加光滑，微表面法线也更加趋近与宏表面法线。

![图 3.0](./MarkdownImages/3.0.jpeg#img_center)

为了更好的模拟镜面反射，我们又构建了一个基于粗糙度的函数:
$$
	S(\theta_h) = {m + 8 \over 8}cos^m(\theta_h) = {m + 8 \over 8}(\vec{n} \cdot \vec{h})^m
$$
其中，归一化因子${m + 8 \over 8}$控制的便是下图函数图像的高度。

![图 3.1](./MarkdownImages/3.1.jpeg#img_center)

---

我们把表面粗糙度和菲涅尔效应的公式结合起来，组成镜面反射的公式。

设光向量为$\vec{L}$, 其入射光量为$\vec{L_B}$, 宏表面法线为$\vec{n}$

根据朗博余弦定理可得实际入射光量为 $max(\vec{n} \cdot \vec{L}) \cdot \vec{L_B}$ ;

设$\alpha_h$为入射光与中间向量(微平面片段法线)$\vec{h}$之间的夹角，$\theta_h$为中间向量与宏表面法线的夹角。

则根据菲涅尔效应, $R_F(\alpha_h)$表示了关于中间向量$\vec{h}$，入射光向量的反射光量(RGB向量)；

又根据表面粗糙度，需要$R_F(\alpha_h)$与$S(\theta_h)$进行分量乘:
\begin{aligned}
	c_s &= max(\vec{n} \cdot \vec{L}) \cdot \vec{L_B} \otimes R_F(\alpha_h)S(\theta_h) \\
		&= max(\vec{n} \cdot \vec{L}) \cdot \vec{L_B} \otimes [R_F(0°) + (1-R_F(0°))(1 - cos\alpha_h)^5][{m + 8 \over 8}(\vec{n} \cdot \vec{h})]
\end{aligned}

---
## 模型概述

我们把环境光、漫反射光以及镜面光结合起来。

1. 环境光$c_a$: 模拟经表面反射的间接光量。
2. 漫反射光$c_d$: 对进入介质内部，又经过表面下吸收而最终散射出表面的光进行模拟。我们假设表面下与介质相互作用后的光从进入表面的地方返回，并向各个方向均匀扩散。
3. 镜面光$c_s$: 模拟经菲涅尔效应和表面粗糙度共同作用的镜面反射光。

\begin{aligned}
	LitColor &= c_a + c_d + c_s	\\
			 &= \vec{A_L} \otimes m_d + max(\vec{L} \cdot \vec{n}, 0) \cdot \vec{B_L} \otimes [m_d + R_F(\alpha_h){m + 8 \over 8}(\vec{n} \cdot \vec{h}^m)]
\end{aligned}

设上述向量均为单位向量。
1. $\vec{L}$: 指向光源的光向量。
2. $\vec{n}$: 表面法线。
3. $\vec{h}$: 光向量与观察向量之间的中间向量。
4. $\vec{A_L}$: 入射的环境光量(RGB, 下同)。
5. $\vec{B_L}$: 入射的直射光量。
6. $m_d$: 漫反射反照率。
7. $\vec{L} \cdot \vec{n}$: 朗博余弦定理。
8. $\alpha_h$: 中间向量$\vec{h}$与光向量$\vec{L}$之间的夹角。
9. $R_F(\alpha_h)$: 菲涅尔效应。
10. $m$: 表面粗糙度。
11. $(\vec{n} \cdot \vec{h})^m$: 微平面法线$\vec{h}$与宏表面法线$\vec{n}$之间夹角为$\theta_h$的所有微平面片段。
12. ${m + 8 \over 8}$: 模拟能量守恒的归一化因子。